name: Deploy Wiki Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'wiki/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'wiki/**'
    types: [ closed ]
  workflow_dispatch: # Allow manual triggering

jobs:
  deploy-wiki:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸš€ Starting Wiki Deployment
      run: |
        echo "ğŸš€ Deploying Egroo Wiki Documentation"
        echo "======================================="
    
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ“ Check Wiki Files
      run: |
        if [ ! -d "wiki" ]; then
          echo "âŒ Error: Wiki files directory not found"
          echo "   Make sure wiki directory exists in the repository root."
          exit 1
        fi
        echo "âœ… Wiki files directory found"
        ls -la wiki/
    
    - name: ğŸ“¥ Clone Wiki Repository
      run: |
        echo "ğŸ“¥ Cloning wiki repository..."
        git clone https://github.com/${{ github.repository }}.wiki.git wiki-repo
    
    - name: ğŸ“‹ Copy Wiki Files
      run: |
        echo "ğŸ“‹ Copying wiki files..."
        cp -r wiki/* wiki-repo/
        
        echo "ğŸ“ Wiki repository contents:"
        ls -la wiki-repo/
    
    - name: ğŸ’¾ Commit and Push Changes
      run: |
        cd wiki-repo
        
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if there are changes
        if git diff --quiet && git diff --cached --quiet; then
          echo "â„¹ï¸  No changes to deploy."
          exit 0
        fi
        
        # Stage all changes
        git add .
        
        # Create commit message with details
        COMMIT_MSG="Update wiki documentation

        - Update comprehensive documentation
        - Add Getting Started guide
        - Add Installation instructions
        - Add Configuration guide
        - Add Development Setup guide
        - Add Deployment guide
        - Add API documentation
        - Add Architecture overview
        - Add Troubleshooting guide

        Auto-deployed from commit ${{ github.sha }}
        Triggered by: ${{ github.event_name }}
        Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        echo "ğŸ’¾ Committing changes..."
        git commit -m "$COMMIT_MSG"
        
        echo "ğŸ“¤ Pushing to GitHub Wiki..."
        git push origin master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: âœ… Deployment Success
      if: success()
      run: |
        echo ""
        echo "âœ… Wiki documentation deployed successfully!"
        echo "ğŸŒ View at: https://github.com/${{ github.repository }}/wiki"
        echo ""
        echo "ğŸ“– Available pages:"
        echo "   â€¢ Home (overview and quick links)"
        echo "   â€¢ Getting Started (quick setup)"
        echo "   â€¢ Installation (detailed setup)"
        echo "   â€¢ Configuration (settings and options)"
        echo "   â€¢ Development Setup (contributor guide)"
        echo "   â€¢ Deployment (production scenarios)"
        echo "   â€¢ API Documentation (REST API + SignalR)"
        echo "   â€¢ Architecture (technical overview)"
        echo "   â€¢ Troubleshooting (common issues)"
    
    - name: âŒ Deployment Failed
      if: failure()
      run: |
        echo ""
        echo "âŒ Wiki deployment failed!"
        echo "Please check the logs above for details."
        echo ""
        echo "Common issues:"
        echo "   â€¢ Wiki repository doesn't exist (create it first)"
        echo "   â€¢ Permissions issue (check repository settings)"
        echo "   â€¢ Wiki files directory missing or empty"
